---
title: 'PFAS/Folate'
author: 'Amber Hall and Harin Lee'
output: html_document
date: '2023-08-07'
---

Date created: July 10, 2023
Date last edited: July 4, 2024

This block of code: 
  
  1. Loads all needed packages.
```{r libraries}
# Clearing all objects, including hidden objects
rm(list = ls(all.names = TRUE))

# Importing needed libraries
suppressWarnings(suppressMessages(library("haven")))
suppressWarnings(suppressMessages(library("tidyverse")))
suppressWarnings(suppressMessages(library("qgcomp")))
suppressWarnings(suppressMessages(library("knitr")))
suppressWarnings(suppressMessages(library("kableExtra")))
suppressWarnings(suppressMessages(library("reshape2"))) #For the heatmap
suppressWarnings(suppressMessages(library("gridExtra")))
suppressWarnings(suppressMessages(library("broom")))
suppressWarnings(suppressMessages(library("bkmr")))
suppressWarnings(suppressMessages(library("patchwork")))
suppressWarnings(suppressMessages(library("cowplot")))
```

This block of code: 

   1. Imports the "pfas_long" and "covars_data" data sets. 
   2. Cleans up the "pfas_long" data set to make a "pfas_only" data set with the pfas, pfc, and participant id data. 
   3. Merges the "pfas_only" data set with the "covars_data" data set to create the "pfas_folate" data set.
```{r import}
# Importing all needed files
pfas_long <- read_sas("/Users/amber/Desktop/Harin/PFAS and Folate/Analysis/Data/biom_pfas.sas7bdat") # imports pfas data set
covars_data <- read_sas("/Users/amber/Desktop/Harin/PFAS and Folate/Analysis/Data/covars_wbf.sas7bdat") # imports covariate data set
folate_data <- read_sas("/Users/amber/Desktop/Harin/PFAS and Folate/Analysis/Data/wbf.sas7bdat") # imports folate data set

# Filtering/cleaning "pfas_long" data set
pfas_only <- pfas_long %>%
  filter(visit == '16W') %>% # removes all values not at 16 weeks' gestation
  filter(twin_set=="") %>% # removes all twins, since twin gestations impact the body in different ways than single gestations
  dplyr::select(-ANALYTE_LOD) %>% 
  dplyr::select(-flg_lod, -twin_set, -visit) %>% 
  pivot_wider(names_from=analyte_code, values_from=pfc) # changes the orientation of the "pfas_only" data set so that participant id is one column and each PFAS is a different column.

# Merging the pfas_only and folate data sets based on participant id
pfas_folate0 <- inner_join(pfas_only, folate_data, by = c("participant_id" = "PARTICIPANT_ID"))
# Merging the pfas_folate0 data set with covars_data data set
pfas_folate <- inner_join(pfas_folate0, covars_data, by = "participant_id") # merges 

# Removing values where the participants don't have folate measures
pfas_folate <- pfas_folate %>%
  filter(!is.na(MFOB_FOTB) | !is.na(PGAB))

# Removing values where the participants don't have parity measures
pfas_folate2<- pfas_folate
pfas_folate <- pfas_folate[complete.cases(pfas_folate$parityn), ]

#Removes missing folate variables
pfas_folate <- pfas_folate %>%
  filter(!is.na(WBF2)) # removing any missing values

# Removing unnecessary dataframes
rm(pfas_only, covars_data, pfas_folate0, folate_data, pfas_folate2)
```

This block of code: 

   1. Categorizes 
        a. Maternal race (White non-Hispanic, Other) 
        b. Prenatal vitamin intake (Daily, Less than daily)
        c. Parity (Nulliparous, Parous)
     Note. These categories were decided after extensive functional form evaluation balancing AICs and biological interpretation as well as addressing data sparsity concerns. 
   2. Categorizes 
        a. Cotinine (<0.015 [Unexposed], 0.015 to 3 [Secondhand], >3 [Active smoker])
        b. Annual household income (<$20,000, $20,000 - $40,000, $40,000 - $80,000, >$80,000)
     Note. These categorical variables were used for table 2 only. They are reported this way due to better interpretability. 
  3. Log-transforms cotinine
```{r covariates}
#Categorizing:
    #Maternal Race
    pfas_folate$mom_race <- as.factor(ifelse(is.na(pfas_folate$mom_race), NA, 
                                          ifelse(pfas_folate$mom_race == "White, non-Hispanic", "White, non-Hispanic", "Other")))
    # Prenatal vitamin intake
    pfas_folate$prenatal_vitamin <- ifelse(is.na(pfas_folate$prenatal_vitamin), NA, 
                                          ifelse(pfas_folate$prenatal_vitamin == "Every day", "Every day", "Less than daily"))
    # Parity
    pfas_folate$parity <- ifelse(is.na(pfas_folate$parityn), NA,
                                  ifelse(pfas_folate$parityn == 0, "Nulliparous", "Parous"))
    # Cotinine (only used in Table 2)
    pfas_folate$cotinine_16w_cat <- as.factor(ifelse
                                              (is.na(pfas_folate$cotinine_16w), NA, 
                                          ifelse(pfas_folate$cotinine_16w <0.015, "Unexposed",
                                                 ifelse(pfas_folate$cotinine_16w > 3, "Active Smoker", "Secondhand"))))
    # Annual household income
    pfas_folate$midincome_cat <- as.factor(ifelse(is.na(pfas_folate$midincome), NA, 
                                          ifelse(pfas_folate$midincome <20000, "<$20,000",
                                                 ifelse(pfas_folate$midincome <40000, "$20,000 to $40,000",
                                                        ifelse(pfas_folate$midincome <80000, "$40,000 to $80,000", ">$80,000")))))
    
# Log-transforming cotinine
pfas_folate$cotinine_16w_log2 <- log2(pfas_folate$cotinine_16w)
```

Table 1. 
These block of code 

   1. Summarizes the numerical values of the data set by finding the mean, standard deviation, median, percentiles, and min/max values of the PFAS. 
  2. Creates a summary table ("pfas_summary") showing the frequency and percentage of each PFAS that is above/below the limit of detection (LOD).
```{r Table_1}
# Looking at the univariate statistics and the number of missing values for the PFAS
# Creating a function to create a summary table with the min, max and quartiles
create_summary <- function(column) {
  data.frame(
    Min = round(min(column, na.rm = TRUE), 1),
    Q1 = round(quantile(column, 0.25, na.rm = TRUE), 1),
    Median = round(median(column, na.rm = TRUE), 1),
    Q3 = round(quantile(column, 0.75, na.rm = TRUE), 1),
    Max =round( max(column, na.rm = TRUE), 1))
}

# Listing the PFAS to be summarized in the order of the table
PFAS_list <- c("PFOA", "PFNA", "PFDEA",
               "PFHXS", "PFOS",
               "PFOSA", "ET-PFOSA-ACOH", "ME-PFOSA-ACOH2")

# Creating a summary table
pfas_univariate <- lapply(PFAS_list, function(col) {
  create_summary(pfas_folate[[col]])
}) %>%
  bind_rows() %>%
  mutate(Analyte = PFAS_list) %>%
  dplyr::select(Analyte, everything())

#Note. Too few PFOSA and ET-PFOSA-ACHOH to look at continuously (missing PFOSA N=205, missing ET_PFOSA-ACHOH N=287)
  # PFDEA is missing N=13 and PFHxS is missing 1. 
  # It is important to note: In this case, all PFAS were measured. As such, missingness denotes those below the LOD, not true missing

#Creating a summary table to describe the n (percent >=LOD)
pfas_LOD_info <- pfas_long %>%
  filter(visit == '16W') %>%
  filter(twin_set == "") %>%
  semi_join(pfas_folate, by = "participant_id") %>%
  group_by(analyte_code) %>%
  summarize(
    N = n(),
    N_Above_LOD = n() - sum(flg_lod),
    Percent_Above_LOD = 100 - (mean(flg_lod) * 100),
    N_Percent_Above_LOD = paste0(n(), " (", round(100 - (mean(flg_lod) * 100), 2), ")")) %>%
    dplyr::select(analyte_code, N_Percent_Above_LOD)

# Joining the two summary tables
Table_1 <- pfas_univariate %>%
  left_join(pfas_LOD_info, by = c("Analyte" = "analyte_code"))

# Printing the combined summary table
print(Table_1)

#Removing unneeded variables
rm(pfas_long, create_summary, PFAS_list, pfas_univariate, pfas_LOD_info)
```

This block of code 

   1. Log-transforms all continuous PFAS (PFOS, PFOA, PFHxS, PFNA, Me-PFOSA-AcOH)
  2. Categorizes Et-PFOSA-AcOH (<LOD, >=LOD) and PFDEA (<0.2, 0.2, >0.2)

Notes. 
   
   a. PFAS in this dataset have already been imputed using the LOD/sqrt(2). 
   b. Et-PFOSA-AcOH was categorized due to a large number of nondetects; PFDEA was categorized around 0.2 ng/mL (<0.2, 0.2, >0.2) due to a point mass issue (specifically, a disproportionate number of individuals had a value at 0.2. This is likely the result of the lab equipment not being specific enough to detect PFDEA with greater precision.)
```{r PFAS_transformations}
# Log transforming PFAS to be used in a functionality form assessment
pfas_folate <- pfas_folate %>%
  mutate(`ME-PFOSA-ACOH2_log2` = log2(`ME-PFOSA-ACOH2`),
        PFHXS_log2 = log2(PFHXS),
        PFNA_log2 = log2(PFNA),
        PFOA_log2 = log2(PFOA),
        PFOS_log2 = log2(PFOS))

# Categorizing Et-FOSAA and PFDEA variables
    # Et-PFOSA-ACOH
      pfas_folate$ETPFOSA_cat <- as.factor(ifelse(is.na(pfas_folate$`ET-PFOSA-ACOH`) | pfas_folate$`ET-PFOSA-ACOH` < 0.1, "0", "1"))

    # PFDEA
      pfas_folate$PFDEA_cat <- as.factor(ifelse(is.na(pfas_folate$PFDEA) | pfas_folate$PFDEA < 0.2, "<0.2", 
                                                ifelse(pfas_folate$PFDEA == 0.2, "0.2", ">0.2")))
```

Table 2. This block of code 

  1. Finds the mean (standard deviation [SD]) for continuous variables and frequency (percentage) for categorical variables 
      
Note. Continuous variables have already been evaluated for normality to ensure that mean (SD) is the best representation of central tendency. 
```{r Table_2_demographics}
# Converting "THFB" to a numeric from character variable
pfas_folate$THFB <- as.numeric(pfas_folate$THFB) 

# Looking at mean and SD for continuous variables
  #Note. Both variables were evaluated and determined to be normally distributed. As such, mean and SD were determined to be the best calculations for central tendency. 
# Calculate means and standard deviations for all continuous variables
maternal_age_mean_sd <- paste(round(mean(pfas_folate$momagedeliv), 1), " (", round(sd(pfas_folate$momagedeliv), 2), ")", sep = "")
folate_mean_sd <- paste(round(mean(pfas_folate$WBF2), 1), " (", round(sd(pfas_folate$WBF2), 2), ")", sep = "")
# Putting these into a data frame to easily print
Table_2_cont <- data.frame(
  Variable = c("Maternal Age", "Folate"),
  Mean_SD = c(maternal_age_mean_sd, folate_mean_sd))

# Printing the results the table
print(Table_2_cont)

# Creating a list of categorical variables
categorical_v <- c("mom_race", "midincome_cat", "cotinine_16w_cat", "prenatal_vitamin", "parity")

# Creating a function to create a summary table for all my categorical variable
table_cat <- function(data, variable) {
  freq_table <- table(data[[variable]])
  perc_table <- round(prop.table(freq_table) * 100, 1)
  summary_table <- data.frame(
    Variable = variable,
    Category = names(freq_table),
    `N (%)` = paste(freq_table, "(", perc_table, ")", sep = ""))
  return(summary_table)
}

# Creating the summary tables for the categorical variables
Table_2_cat <- do.call(rbind, lapply(categorical_v, function(var) table_cat(pfas_folate, var)))

# Printing the results
print(Table_2_cat)

# Removing items that are unnecessary
rm(table_cat, folate_mean_sd, maternal_age_mean_sd)
```

This block of code

  1. Determines the mean (SD) of folate for each category of the demographic variables
```{r Table_2_folate}
# Creating a function to calculate mean and SD for each category of a variable
calc_mean_sd <- function(df, cat_var, value_var) {
  df %>%
    group_by(!!sym(cat_var)) %>%
    summarize(mean_sd = paste0(
      round(mean(!!sym(value_var), na.rm = TRUE), 1), 
      " (", round(sd(!!sym(value_var), na.rm = TRUE), 2), ")")) %>%
    mutate(variable = cat_var) %>%
    rename(category = !!sym(cat_var))
}

# Applying the function to each categorical variable
results <- lapply(categorical_v, calc_mean_sd, df = pfas_folate, value_var = "WBF2")

# Combining all results into one data frame
Table_2_folate <- bind_rows(results)

# Print the results
print(Table_2_folate) 

# Removing items that are unnecessary
rm(categorical_v, calc_mean_sd, results)
```

This block of code 

   1. Creates a correlation heat map of log2-transformed PFAS using pearson correlation coefficients.
```{r Figure_S2}
# Creating a data set of the numerical 'pfas_folate' data called data_num to be used in creating a correlation matrix. 
    #Note. Only PFAS that are analyzed continuously are included
data_num <- pfas_folate %>%
  dplyr::select(`ME-PFOSA-ACOH2_log2`, PFHXS_log2, PFNA_log2, PFOA_log2, PFOS_log2) %>%
  dplyr::select(where(is.numeric))
data_num <- data_num %>%
  rename(`Me-PFOSA-AcOH` = `ME-PFOSA-ACOH2_log2`,
    PFHxS = PFHXS_log2,
    PFNA = PFNA_log2,
    PFOA = PFOA_log2,
    PFOS = PFOS_log2)

# Creating a correlation matrix using the data_num set. Correlation matrix only includes complete cases (no missing values) and rounds to 2 decimal places
    #Note. As data have been imputed, complete cases technically do not need to be specified for this data.
corr_mat <- round(cor(data_num, use = "complete.obs"), 2)

# 'Melting' the correlation matrix so that it can be used in a heat map
melted_corr_mat <- melt(replace(corr_mat, upper.tri(corr_mat, diag = FALSE), NA), na.rm = TRUE)

# Plotting the correlation heat map using ggplot
PFAS_corr <-ggplot(data = melted_corr_mat, aes(x = Var1 , y = Var2, fill = value)) +
  labs(y = "", x = "") +
  geom_tile() + 
  geom_text(aes(Var1, Var2, label = value), color = "black", size = 3) +
  scale_fill_gradient2(
    low = "white", 
    high = "red", 
    limits = c(0, 1), 
    name = "Pearson R", 
    guide = guide_colorbar(
      frame.colour = "black", 
      frame.linewidth = 0.3,
      ticks.colour = "black")) +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill="white", color=NA),
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", size = 0.3),
    axis.text.x = element_text(size = 10, color = "black"),
    axis.text.y = element_text(size = 10, color = "black"),
    legend.box.background = element_rect(color = "black", fill = NA, linewidth = 0.3),  
    legend.box.margin = margin(5, 5, 5, 5)) 

# Printing the figure
print(PFAS_corr)

#Exporting the figure out into a folder on my computer
fig_cont <-ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/SFigure2.tiff", plot = PFAS_corr, 
       device = "tiff", 
       width = 7.5, height = 4, units = "in", 
       dpi = 300)

# Removing items that are unnecessary
rm(data_num, corr_mat, melted_corr_mat, fig_cont, PFAS_corr)
```

This block of code

  1. Runs the linear regression models for the 5 continuously analyzed log2(PFAS) adjusting for parity, prenatal vitamin intake, maternal race, income, maternal age, and cotinine.
``` {r Table_S1_LR_linear_adj}
# Renaming the Me-PFOSA-AcOH variable
pfas_folate$MeFOSAA_log2 <- pfas_folate$`ME-PFOSA-ACOH2_log2`

# Creating a list of PFAS variables to evaluate
PFAS <- c('PFOA_log2', 'PFOS_log2', 'PFNA_log2', 'PFHXS_log2', 'MeFOSAA_log2')

# Creating a function to fit the model and extract results
    #Note. All categorical variables have been checked to ensure they are not numerically coded
extract_model_results <- function(pfas_var, data) {formula <- as.formula(paste("WBF2 ~", pfas_var, "+ parity + prenatal_vitamin + mom_race + midincome + momagedeliv + cotinine_16w_log2"))
  model <- lm(formula, data = data)
  summary_fit <- summary(model)
  conf_int <- confint(model)
#Creating a dataframe with all the needed output for tables
  data.frame(PFAS = pfas_var,
    Estimate_CI = paste0(round(summary_fit$coefficients[pfas_var, "Estimate"], 1),
                         " (", round(conf_int[pfas_var, 1], 1), ", ", round(conf_int[pfas_var, 2], 1), ")"))}

# Looping through the PFAS variables in my PFAS list and combining the results into a single dataframe. 
Table_S1_cont_adj <- do.call(rbind, lapply(PFAS, extract_model_results, data = pfas_folate))

# Printing the results
print(Table_S1_cont_adj)

# Removing items that are unnecessary
rm(extract_model_results)
```

This block of code 
   
   1. Runs the CRUDE linear regression models for the 5 continuously analyzed log2(PFAS) [i.e. does not adjust for covariates].
    
Note. The maternal race variable changes PFNA and PFHxS from statistically significant to not significant. As such, it's important to note that the PFAS-folate relationship for this data is confounded by race. 
``` {r Table_S1_LR_linear_CRUDE}
# Creating a function to fit the model and extract results
    #Note. All categorical variables have been checked to ensure they are not numerically coded
extract_model_results_CRUDE <- function(pfas_var, data) {
  formula <- as.formula(paste("WBF2 ~", pfas_var))
  model <- lm(formula, data = data)
  summary_fit <- summary(model)
  conf_int <- confint(model)
#Creating a dataframe with all the needed output
  data.frame(
    PFAS = pfas_var,
    Estimate_CI = paste0(round(summary_fit$coefficients[pfas_var, "Estimate"], 1),
                         " (", round(conf_int[pfas_var, 1], 1), ", ", round(conf_int[pfas_var, 2], 1), ")"))}

# Looping through the PFAS variables in the PFAS list in the previous block of code and combining the results
Table_S1_cont_CRUDE <- do.call(rbind, lapply(PFAS, extract_model_results_CRUDE, data = pfas_folate))

# Printing the results
print(Table_S1_cont_CRUDE)

# Removing items that are unnecessary
rm(extract_model_results_CRUDE, PFAS)
```

This block of code 

  1. Runs the linear regression models for the 2 categorically analyzed PFAS (PFDEA and Et-FOSAA), adjusting for parity, prenatal vitamin intake, maternal race, income, maternal age, and cotinine.
``` {r Table_S1_LR_cat_adj}
# Running the linear regression models
pfdea_results <- lm(WBF2 ~ PFDEA_cat + parity + prenatal_vitamin + mom_race + midincome + momagedeliv + cotinine_16w_log2, data = pfas_folate)

etfosaa_results <- lm(WBF2 ~ ETPFOSA_cat + parity + prenatal_vitamin + mom_race + midincome + momagedeliv + cotinine_16w_log2, data = pfas_folate)

# Extracting summaries of the models
pfdea_summary <- summary(pfdea_results)
etfosaa_summary <- summary(etfosaa_results)
# Extracting confidence intervals for both models
pfdea_conf_int <- confint(pfdea_results)
etfosaa_conf_int <- confint(etfosaa_results)
# Extracting coefficient names for both models
pfdea_coef_names <- rownames(pfdea_summary$coefficients)
etfosaa_coef_names <- rownames(etfosaa_summary$coefficients)

# Filtering for relevant coefficients
  # Note. This part was necessary as PFDEA had more than 2 levels
pfdea_coef_names <- grep("PFDEA_cat", pfdea_coef_names, value = TRUE)
etfosaa_coef_names <- grep("ETPFOSA_cat", etfosaa_coef_names, value = TRUE)

# Putting the results into 2 data frames
pfdea_results_df <- data.frame(PFAS = pfdea_coef_names,
                               Estimate_CI = paste0(Estimate_CI = round(pfdea_summary$coefficients[pfdea_coef_names, "Estimate"], 1), 
  " (", round(pfdea_conf_int[pfdea_coef_names, 1], 1), ", ", round(pfdea_conf_int[pfdea_coef_names, 2], 1), ")"))

etfosaa_results_df <- data.frame(PFAS = etfosaa_coef_names,
                                 Estimate_CI = paste0(Estimate_CI = round(etfosaa_summary$coefficients[etfosaa_coef_names, "Estimate"], 1), 
  " (", round(etfosaa_conf_int[etfosaa_coef_names, 1], 1), ", ", round(etfosaa_conf_int[etfosaa_coef_names, 2], 1), ")"))

# Merging the two results data frames
Table_S1_cat_adj <- rbind(etfosaa_results_df, pfdea_results_df)

# Printing the merged results
print(Table_S1_cat_adj)

# Removing items that are unnecessary
rm (pfdea_results, etfosaa_results, pfdea_summary, etfosaa_summary, pfdea_conf_int, etfosaa_conf_int, pfdea_coef_names, etfosaa_coef_names, pfdea_results_df, etfosaa_results_df)
```

This block of code 

  1. Runs the CRUDE linear regression models for the 2 categorically analyzed PFAS.
``` {r Table_S1_LR_cat_CRUDE}
# Running the linear regression models for each PFAS
# PFDEA
pfdea_results <- lm(WBF2 ~ PFDEA_cat, data = pfas_folate)
# Et-PFOSAA
etfosaa_results <- lm(WBF2 ~ ETPFOSA_cat, data = pfas_folate)

# Extracting summaries of the models
pfdea_summary <- summary(pfdea_results)
etfosaa_summary <- summary(etfosaa_results)

# Extracting confidence intervals for both models
pfdea_conf_int <- confint(pfdea_results)
etfosaa_conf_int <- confint(etfosaa_results)
# Extracting coefficient names for both models
pfdea_coef_names <- rownames(pfdea_summary$coefficients)
etfosaa_coef_names <- rownames(etfosaa_summary$coefficients)

# Filtering for relevant coefficients
pfdea_coef_names <- grep("PFDEA_cat", pfdea_coef_names, value = TRUE)
etfosaa_coef_names <- grep("ETPFOSA_cat", etfosaa_coef_names, value = TRUE)

# Putting the results into 2 data frames
#PFDEA
pfdea_results_df <- data.frame(PFAS = pfdea_coef_names,
                               Estimate_CI = paste0(
                                  round(pfdea_summary$coefficients[pfdea_coef_names, "Estimate"], 1),
                                      " (", round(pfdea_conf_int[pfdea_coef_names, 1], 1), ", ", 
                                      round(pfdea_conf_int[pfdea_coef_names, 2], 1), ")"))
#Et-PFOSAA
etfosaa_results_df <- data.frame(PFAS = etfosaa_coef_names,
                                 Estimate_CI = paste0(round(etfosaa_summary$coefficients[etfosaa_coef_names, "Estimate"], 1),
                                        " ", round(etfosaa_conf_int[etfosaa_coef_names, 1], 1), ", ", 
                                        round(etfosaa_conf_int[etfosaa_coef_names, 2], 1), ")"))

# Merging the 2 PFAS-specific data frames into a single data frame
Table_S1_cat_CRUDE <- rbind(etfosaa_results_df, pfdea_results_df)

# Printing the merged results
print(Table_S1_cat_CRUDE)

# Removing items that are unnecessary
rm (pfdea_results, etfosaa_results, pfdea_summary, etfosaa_summary, pfdea_conf_int, etfosaa_conf_int, pfdea_coef_names, etfosaa_coef_names, pfdea_results_df, etfosaa_results_df)
```

This block of code 

  1. Creates the output for Supplemental Table 1 by combing the four tables I created in the 2 code blocks above. 
``` {r Table_S1_Final}
# Combining the 2 adjusted dataframes
Table_S1_adj <- rbind(Table_S1_cont_adj, Table_S1_cat_adj)

# Combining the 2 crude dataframes
Table_S1_CRUDE <- rbind(Table_S1_cont_CRUDE, Table_S1_cat_CRUDE)

# Placing the 2 new dataframes side by side
Table_S1 <- cbind(Table_S1_CRUDE, Table_S1_adj[, -1])

# Creating column headers
colnames(Table_S1) <- c("PFAS", "Crude Estimate (95% CI)", "Adjusted Estimate (95% CI)")

# Printing out Supplemental Table 1
print(Table_S1)

# Removing the other 4 tables and the newly created adj and crude tables for simplicity
rm (Table_S1_cont_adj, Table_S1_cat_adj, Table_S1_cont_CRUDE, Table_S1_cat_CRUDE, Table_S1_adj, Table_S1_CRUDE)
```

This block of code 
  
   1. Creates a plot to display the results from the adjusted linear regression models for all continuous variables
``` {r Figure1_cont}
# Creating a dataframe with the results from the linear regression models (see above)
data <- data.frame(
  PFAS = factor(c("PFOS", "PFOA", "PFNA", "PFHxS", "Me-PFOSA-AcOH"), 
                levels = c("PFOS", "PFOA", "PFNA", "PFHxS", "Me-PFOSA-AcOH")),
  Estimate = c(5.7, 11.8, 27.1, 13.7, -5.6),
  Lower_CI = c(-27.9, -21.6, -18.4, -10.2, -32.9),
  Upper_CI = c(39.2, 45.2, 72.6, 37.6, 21.8))

# Creating the plot
fig1_cont<- ggplot(data, aes(x = Estimate, y = PFAS)) +
  geom_point(color = "black") +
  geom_errorbarh(aes(xmin = Lower_CI, xmax = Upper_CI), height = 0.2, color = "black") +
  geom_vline(xintercept = 0, linetype = "dotted", color = "red") +
  labs(x = expression(beta ~ "(95% CI)"), y = "") +
  scale_x_continuous(limits = c(-40,80), breaks = seq(-40, 80, by = 10)) +
  theme_minimal(base_size = 12) +
  theme(
    plot.background = element_rect(fill="white", color=NA),
    axis.line = element_line(color = "black"),
    axis.text = element_text(color = "black", size = 10),
    axis.title = element_text(color = "black", size = 12),
    plot.title = element_text(color = "black", size = 12),
    axis.ticks.x = element_line(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())

# Printing the figure
print(fig1_cont)

#Exporting the figure out into a folder on my computer
fig1_cont <-ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/Figure1_cont.tiff", plot = fig1_cont, 
       device = "tiff", 
       width = 7, height = 2, units = "in", 
       dpi = 300)

# Removing items that are unnecessary
rm(data, fig1_cont)
```

This block of code

   1. Creates a plot to display the results from the adjusted linear regression models for all categorical variables
``` {r Figure1_cat}
# Creating a dataframe for coategorical variables
data <- data.frame(
  PFAS = factor(c("PFDEA (>0.2 ng/mL)", "PFDEA (0.2 ng/mL)", "", "Et-FOSAA (\u2265 LOD)"), 
                levels = c("PFDEA (>0.2 ng/mL)", "PFDEA (0.2 ng/mL)", "", "Et-FOSAA (\u2265 LOD)")),
  Estimate = c(51.0, 67.4, NA, -32.2),
  Lower_CI = c(-18.4, 4.5, NA, -87.3),
  Upper_CI = c(120.3, 130.4, NA, 22.9))

# Making the plot
fig1_cat <- ggplot(data, aes(x = Estimate, y = PFAS)) +
  geom_point(color = "black", na.rm = TRUE) +
  geom_errorbarh(aes(xmin = Lower_CI, xmax = Upper_CI), height = 0.2, color = "black", na.rm = TRUE) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "red") +
  labs(x = expression(beta ~ "(95% CI)"), y = "") +
  scale_x_continuous(limits = c(-100, 140), breaks = seq(-100, 160, by = 20)) +
  theme_minimal(base_size = 12) +
  theme(
    plot.background = element_rect(fill="white", color=NA),
    axis.line = element_line(color = "black"),
    axis.text = element_text(color = "black", size = 10),
    axis.title = element_text(color = "black", size = 12),
    plot.title = element_text(color = "black", size = 12),
    axis.ticks.x = element_line(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())

# Printing the figure
print(fig1_cat)

# Exporting the figure out
fig1_cat <-ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/Figure1_cat.tiff", plot = fig1_cat, 
       device = "tiff", 
       width = 7, height = 1.7, units = "in", 
       dpi = 300)

# Removing items that are unnecessary
rm(data, fig1_cat)
```

This block of code 

  1. Runs the quantile-based g-computation model for the 5 continuously analyzed log2(PFAS), adjusted for covariates.

Note. For more on quantile-based g-computation, visit: https://ehp.niehs.nih.gov/doi/full/10.1289/EHP5838
``` {r QG_comp}
# Creating a list of the PFAS I am evaluating called Xnm
Xnm <- c('MeFOSAA_log2', 'PFHXS_log2', 'PFNA_log2', 'PFOA_log2', 'PFOS_log2')

# Running the quantile-based g-computation model
# Note: This is using default settings (looking at quartiles, not bootstrapping, etc)
qc.fitadj <- qgcomp.noboot(
  WBF2 ~ PFOS_log2 + PFOA_log2 + PFNA_log2 + PFHXS_log2 + MeFOSAA_log2 +
    parity + prenatal_vitamin + mom_race + midincome + momagedeliv + cotinine_16w_log2,
  expnms = Xnm, data = pfas_folate, family = gaussian()
)

# Extracting the results from the model
estimates <- coef(qc.fitadj)
conf_intervals <- confint(qc.fitadj)

# Creating a dataframe with the results and removing the intercept row
qg_comp_results <- data.frame(
  Estimate_95CI = paste0(
    round(as.numeric(estimates), 1), " (", 
    round(conf_intervals[, 1], 1), ", ", 
    round(conf_intervals[, 2], 1), ")")
)
qg_comp_results <- qg_comp_results[-1, , drop = FALSE]  # Drop = FALSE to keep as dataframe

# Printing the results
print(qg_comp_results)

# Removing items that are unnecessary
rm(estimates, conf_intervals, qc.fitadj, Xnm)
```

This block of code creates 

   1. A figure to display the fixed weights from the quantile-based g-computation model
``` {r Figure_S3}
# Creating a dataset to use for this figure
    #Note. This data was obtained from the quantile-based g-computation model in the chunk above. 
qgcomp.df <- data.frame(
  category = c("PFHxS", "PFNA", "Me-PFOSA-AcOH", "PFOS", "PFOA"),
  value_positive = c(0.594, 0.406, NA, NA, NA),
  value_negative = c(NA, NA, -0.424, -0.389, -0.187))

qgcomp_wt_plot <- ggplot(qgcomp.df, aes(y = category)) +
  geom_bar(aes(x = value_positive), stat = "identity", fill = "red", position = "identity") +
  geom_bar(aes(x = value_negative), stat = "identity", fill = "blue", position = "identity") +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill="white", color=NA),
    panel.grid = element_blank(), 
    axis.line.x = element_line(color = "black", size = 0.3),
    axis.line.y = element_line(color = "black", size = 0.3),
    axis.text.x = element_text(size = 10, color = "black"),
    axis.text.y = element_text(size = 10, color = "black"),
    axis.title.x = element_text(size = 12, color = "black"),
    axis.title.y = element_text(size = 12, color = "black"),
    axis.ticks.x = element_line(color = "black", size = 0.3)) +
  labs(y = "", x = c("Negative weights                                Positive weights")) + #Only way I knew to get the spacing I wanted. There is probably a better way to do this. 
  scale_x_continuous(
    breaks = seq(-1, 1, by = 0.25),
    limits = c(-.9, .9),
    labels = seq(-1, 1, by = 0.25)) +
  geom_vline(xintercept = 0, color = "black", size = 0.5)

# Printing the figure
print(qgcomp_wt_plot)

#Exporting the figure out into a folder on my computer
qgcomp_wt_plot <-ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/SFigure3.tiff", plot = qgcomp_wt_plot, 
       device = "tiff", 
       width = 7.5, height = 4, units = "in", 
       dpi = 300)

# Removing items that are unnecessary
rm(qgcomp.df, qgcomp_wt_plot)
```

This block of code 

   1. Runs the Bayesian Kernel Machine Regression (BKMR) model for the 5 continuously analyzed log2(PFAS), adjusted for covariates.
    
Note. For more on BKMR, visit: https://jenfb.github.io/bkmr/overview.html
``` {r BKMR_adj}
# Creating a matrix of outcomes
y <- as.matrix(pfas_folate$WBF2)
  
# Creating a matrix of exposures
Z <- as.matrix(pfas_folate[, c('MeFOSAA_log2', 'PFHXS_log2', 'PFNA_log2', 'PFOA_log2', 'PFOS_log2')])

# Recoding categorical dummy variables to use for these analyses
pfas_folate$parity_num <- ifelse(pfas_folate$parity == "Parous", 1, 0)
pfas_folate$prenatal_vitamin_num <- ifelse(pfas_folate$prenatal_vitamin == "Every day", 1, 0)
pfas_folate$mom_race_num <- ifelse(pfas_folate$mom_race == "White, non-Hispanic", 1, 0)

# Creating a matrix of covariates
X <- as.matrix(pfas_folate[, c( "parity_num", "prenatal_vitamin_num", "mom_race_num", "midincome", "momagedeliv", "cotinine_16w_log2")])

# Fiting the BKMR model
  # Setting the seed to 42 to indicate the 'meaning of life'
        # Note: see The Hitchhiker's Guide to the Galaxy for reference
  # MCMC
  # 50,000 iterations to be extra

set.seed(42)
fitkm <- kmbayes(y = y, Z = Z, X = X, iter = 50000, verbose = FALSE, varsel = TRUE) # varsel = TRUE in order to get PIPs
```

This block of code 

   1.Extracts posterior inclusion probabilities (PIPs) for each PFAS in the model. These PIPs represent the contribution of each PFAS to the overall mixture
``` {r Table_S2}
# Extracting the PIPs from the BKMR model
PIPs<- ExtractPIPs(fitkm)
```

This block of code 

  1. Creates a plot of the adjusted differences in total folate levels by PFAS mixture quantile (ranging from 25% to 75%). 
``` {r Figure_2} 
# Calculating the difference in folate levels for each quantile
risks.overall <- OverallRiskSummaries(fit = fitkm, y = y, Z = Z, X = X, 
                                     qs = seq(0.25, 0.75, by = 0.05), 
                                      q.fixed = 0.5, method = "exact")

# Creating a figure to display the results
Quant <- ggplot(risks.overall, aes(x = quantile, y = est, ymin = est - 1.96 * sd, ymax = est + 1.96 * sd)) +
  geom_pointrange() +
  theme_bw() +  # Sets the background to white
  geom_hline(yintercept = 0, linetype = "dotted", color = "red") +  # Adds a dotted red line at y = 0
  labs(x = "PFAS mixture quantile (percentile)", y = "Difference in total folate (nmol/L)") +  
  scale_x_continuous(breaks = c(0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75), labels = c("25th", "30th", "35th", "40th", "45th", "50th", "55th", "60th", "65th", "70th", "75th")) +  
  theme(
    plot.background = element_rect(fill="white", color=NA),
    axis.text = element_text(size = 10, color = "black"),  
    axis.title = element_text(size = 12, color = "black"),  
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(),  
    axis.line.x = element_line(color = "black", size = 0.5),  
    axis.line.y = element_line(color = "black", size = 0.5),
    axis.ticks = element_line(color = "black", size = 0.5))

# Printing the figure
print(Quant)

# Exporting the figure out into a folder on my computer
Quant <-ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/Figure2.tiff", plot = Quant, 
       device = "tiff", 
       width = 7.5, height = 4, units = "in", 
       dpi = 300)

#Removing unneeded items
rm(Quant, risks.overall)
```

This block of code 

   1. Creates a plot of adjusted differences in total folate for each PFAS (by quartile; i.e. ranging from 25% to 75%). 
``` {r Figure_3}
# Calculating adjusted differences in total folate for each PFAS (by quartile), with other PFAS set at the median
risks.singvar <- SingVarRiskSummaries(fit = fitkm, qs.diff = c(0.25, 0.75),
                                      q.fixed = c(0.25, 0.50, 0.75), 
                                      method = "approx")

# Creating a set of labels for the PFAS to use in the plot
labels <- c(
  "MeFOSAA_log2" = "Me-PFOSA-AcOH",
  "PFHXS_log2" = "PFHxS",
  "PFNA_log2" = "PFNA",
  "PFOA_log2" = "PFOA",
  "PFOS_log2" = "PFOS")

# Creating the plot
fig3 <- ggplot(risks.singvar, aes(x = variable, y = est, ymin = est - 1.96 * sd, ymax = est + 1.96 * sd, col = q.fixed)) + 
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "red") +  
  geom_pointrange(position = position_dodge(width = 0.75), size = 0.7) +
  coord_flip() + 
  theme_minimal(base_size = 15) + 
  theme(
    # Ensuring the background is white
    plot.background = element_rect(fill = "white", color = NA),
    # Legend
    legend.position = "right",  
    legend.title = element_text(size = 12, color = "black"),  
    legend.text = element_text(size = 10, color = "black"), 
    legend.background = element_rect(color = "black", fill = NA, linewidth = 0.5),
    # Axis labels
    axis.title.x = element_text(size = 12, color = "black"),
    axis.text.x = element_text(size = 10, color = "black"),
    axis.text.y = element_text(size = 12, color = "black"),
    # Removing gridlines
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(),  
    panel.border = element_blank(),  
    # Specifying other elements I would like
    axis.line.x = element_line(color = "black", size = 0.5),  
    axis.line.y = element_line(color = "black", size = 0.5),  
    axis.ticks.x = element_line(color = "black", size = 0.5),  
    axis.ticks.length.x = unit(0.2, "cm")) + 
  scale_x_discrete(name = "", labels = labels) +
  scale_y_continuous(name = "Difference in total folate (nmol/L)", limits = c(-60, 60), breaks = seq(-60, 60, by = 20)) +
  scale_color_manual(name = "Quartile", values = c("red", "darkgreen", "blue"), labels = c("25%", "50%", "75%"))

# Printing the figure
print(fig3)

# Exporting the figure to a folder on your computer
ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/Figure3.tiff", plot = fig3, device = "tiff", width = 7.5, height = 4, units = "in", dpi = 300)

# Removing items I do not need
rm(fig3, risks.singvar)
```

This block of code 

   1. Creates bivariate plots of PFAS to evaluate interactions between each PFAS with one another (10th, 50th, and 90th percentiles) when all other PFAS are fixed at the median. 
``` {r Figure_4}
pred.resp.bivar <- PredictorResponseBivar(fit = fitkm, min.plot.dist = 1)
pred.resp.bivar.levels <- PredictorResponseBivarLevels(
  pred.resp.df = pred.resp.bivar, Z = Z, qs = c(0.1, 0.5, 0.9))

# Creating labels to use in these plots
labels2 <- c(
  "MeFOSAA_log2" = "Me-PFOSA-AcOH associations when\n another PFAS is fixed at the 10th, 50th,\n and 90th percentile",
  "PFHXS_log2" = "PFHxS associations when another PFAS is\n fixed at the 10th, 50th, and 90th percentile",
  "PFNA_log2" = "PFNA associations when another PFAS is\n fixed at the 10th, 50th, and 90th percentile",
  "PFOA_log2" = "PFOA associations when another PFAS is\n fixed at the 10th, 50th, and 90th percentile",
  "PFOS_log2" = "PFOS associations when another PFAS is\n fixed at the 10th, 50th, and 90th percentile")

# Creating a function to make each PFAS plot
create_plot <- function(data, variable) {
  ggplot(data, aes(x = z1, y = est, color = factor(quantile))) + 
    geom_smooth(stat = "identity", size = 1) +  
    geom_hline(yintercept = 0, linetype = "dotted", color = "black") +  
    facet_grid(variable2 ~ variable1, labeller = labeller(variable1 = labels2, variable2 = labels)) +
    scale_color_manual(values = c("red", "darkgreen", "blue")) +  
    theme_minimal(base_size = 15) +  
    labs(x = "PFAS z-score\n", y = "Total folate (nmol/L)") +  
    ylim(-60, 80) +
    theme(
      axis.title = element_text(size = 16, color = "black"),  
      axis.text = element_text(size = 14, color = "black"),  
      strip.text = element_text(size = 16),  
      strip.text.y = element_text(angle = 0),  
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      panel.border = element_rect(color = "black", fill = NA),  
      legend.position = "none",  
      plot.margin = unit(c(1, 1, 1, 1), "cm"),  
      plot.background = element_rect(fill = "white", color = NA),
      )
}

# Creating individual PFAS plots
plots <- lapply(unique(pred.resp.bivar.levels$variable1), function(var) {
  data_filtered <- pred.resp.bivar.levels %>% filter(variable1 == var)
  create_plot(data_filtered, var)
  }
  )

# Combining these plots into a 2-column singular figure
bkmr_int <- wrap_plots(plots, ncol = 2) &
  theme(plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"))

# Exporting this figure out
ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/Figure4.tiff", 
       plot = bkmr_int, device = "tiff", width = 14, height = 20, dpi = 300)

# Removing items I do not need
rm (pred.resp.bivar, pred.resp.df, labels2, create_plot, plots, bkmr_int)
```

This block of code

   1. Creates the legend for Figure 4

Note. I put these together in ppt and export the final figure out as a .tiff file. 
``` {r Figure_4_Legend} 
# Filtering the data for Me-PFOSA-AcOH for efficiency 
mefosaa_data <- pred.resp.bivar.levels[pred.resp.bivar.levels$variable1 == "MeFOSAA_log2", ]

# Creating a dummy plot to extract the legend
dummy_plot <- ggplot(mefosaa_data, aes(x = z1, y = est, color = factor(quantile))) + 
  geom_point(size = 3) +
  scale_color_manual(name = "Quantile", values = c("red", "darkgreen", "blue"), labels = c("10%", "50%", "90%")) +
  theme_minimal(base_size = 15) +
  theme(
    legend.title = element_text(size = 12, color = "black"),  
    legend.text = element_text(size = 10, color = "black"), 
    legend.background = element_rect(color = "black", fill = NA, linewidth = 0.5),
    plot.background = element_rect(fill = "white", color = NA))

# Extracting the legend
legend <- get_legend(dummy_plot)

# Creating a blank plot with only the legend
legend_plot <- ggdraw() + draw_grob(legend)

# Printing the legend
print(legend_plot)

# Saving the legend plot to a file
ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/Figure4_Legend.tiff", 
       plot = legend_plot, 
       device = "tiff", 
       width = 3, height = 3, units = "in", 
       dpi = 300)

# Removing items I do not need
rm (dummy_plot, legend, mefosaa_data, legend_plot, pred.resp.bivar.levels)
```

This block of code 

   1. Creates dose-response curves for each PFAS for the relationship between total folate and PFAS z-scores in the BKMR model, when all other PFAS are set at the median
``` {r Figure_S4}
# Modeling the relationship between each PFAS and folate, where all of the other exposures are fixed at the 50th percentile.
pred.resp.univar <- PredictorResponseUnivar(fit = fitkm)

# Plotting this relationship
DR <- ggplot(pred.resp.univar, aes(z, est, ymin = est - 1.96*se, ymax = est + 1.96*se)) + 
    geom_smooth(stat = "identity", color = "blue", fill = "lightblue", linewidth = 1) + 
    facet_wrap(~ variable, scales = "free", labeller = labeller(variable = labels)) +
    ylab("Total folate (nmol/L)") +
    xlab("") +
    theme_minimal() +
    theme(
      plot.background = element_rect(fill = "white", color = NA),
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      strip.text = element_text(size = 10))

# Printing the figure
print(DR)

# Exporting this figure out
ggsave(filename = "/Users/amber/Desktop/PFAS and Folate/Figures/SFigure4.tiff", 
       plot = DR, 
       device = "tiff", 
       width = 7, height = 5, 
       dpi = 300)

# Removing items that are unnecessary
rm(pred.resp.univar, labels, DR)
```

This block of code 
  
  1. Evaluates effect measure modification (EMM) by maternal race. 

Note. EMM for the 3 categories of the PFDEA was only evaluated in comparison to the ref (<0.2)
``` {r Table_S3}
# Adding a new mom_race variable to use later where the reference level is opposite than coded
pfas_folate$momrace_relev <- relevel(pfas_folate$mom_race, ref = "White, non-Hispanic")

# Recategorizing Et-PFOSA as numeric
pfas_folate$ETPFOSA_cat <- as.numeric(pfas_folate$ETPFOSA_cat)

# Creating a helper function to extract and store results
extract_results <- function(model, var_name) {
  coefs <- coef(summary(model))
  if (var_name %in% rownames(coefs)) {
    est <- round(coefs[var_name, "Estimate"], 1)
    ci <- round(confint(model, level = 0.95)[var_name, ], 1)
    combined <- paste0(est, " (", ci[1], ", ", ci[2], ")")
    p_val <- round(coefs[var_name, "Pr(>|t|)"], 3)
    return(data.frame(
      PFAS = var_name,
      Estimate_CI = combined,
      P_Value = p_val,
      stringsAsFactors = FALSE))
  } else {
    return(data.frame(
      PFAS = var_name,
      Estimate_CI = NA,
      P_Value = NA,
      stringsAsFactors = FALSE))
  }
}

# Creating a function to help import multiple PFAS 
process_pfas <- function(pfas_list, data) {
  # Initializing an empty data frame to store combined results
  combined_results <- data.frame(
    PFAS = character(),
    Estimate_CI_White = character(),
    Estimate_CI_Other = character(),
    P_Value_Interact = numeric(),
    stringsAsFactors = FALSE)
  # Looping through each PFAS in the list
  for (pfas_var in names(pfas_list)) {
    # Other group model
    model_Other <- lm(as.formula(paste("WBF2 ~", pfas_var, "* momrace_relev +", pfas_var, "+ parity + prenatal_vitamin + momrace_relev + midincome + momagedeliv + cotinine_16w_log2")), data = data)
    results_Other <- extract_results(model_Other, pfas_var)
    # White group model
    model_White <- lm(as.formula(paste("WBF2 ~", pfas_var, "* mom_race +", pfas_var, "+ parity + prenatal_vitamin + mom_race + midincome + momagedeliv + cotinine_16w_log2")), data = data)
    results_White <- extract_results(model_White, pfas_var)
    # Interaction p-value
    interaction_term <- paste0(pfas_var, ":mom_raceWhite, non-Hispanic")
    coefs_White <- coef(summary(model_White))
    if (interaction_term %in% rownames(coefs_White)) {
      interaction_p_val <- round(coefs_White[interaction_term, "Pr(>|t|)"], 3)
    } else {
      interaction_p_val <- NA
    }
    # Combining the results into a single row
    combined_results <- rbind(combined_results, data.frame(
      PFAS = pfas_list[[pfas_var]],
      Estimate_CI_White = results_White$Estimate_CI,
      Estimate_CI_Other = results_Other$Estimate_CI,
      P_Interaction = interaction_p_val,
      stringsAsFactors = FALSE))
  }
  return(combined_results)
}

# Creating a list of all PFAS (including categorical Et-FOSAA)
pfas_list <- c("PFOA_log2" = "PFOA",
               "PFOS_log2" = "PFOS",
               "PFNA_log2" = "PFNA",
               "PFHXS_log2" = "PFHxS",
               "MeFOSAA_log2" = "Me-PFOSA-AcOH",
               "ETPFOSA_cat" = "Et-FOSAA")

# Getting the results and printing them
Table_S3_noPFDEA <- process_pfas(pfas_list, pfas_folate)

# Evaluating the categorized PFDEA variable:
# Running the models
# Other group model
model_Other <- lm(WBF2 ~ PFDEA_cat * momrace_relev + PFDEA_cat + parity + prenatal_vitamin + momrace_relev + midincome + momagedeliv + cotinine_16w_log2, data = pfas_folate)
# White group model
model_White <- lm(WBF2 ~ PFDEA_cat * mom_race + PFDEA_cat + parity + prenatal_vitamin + mom_race + midincome + momagedeliv + cotinine_16w_log2, data = pfas_folate)

# Create a data frame with the required values
PFDEA_results <- data.frame(
  PFDEA_Cat = c("=0.2", "=0.2", ">0.2", ">0.2"),
  Group = c("White, non-Hispanic", "Another Race or Ethnicity", "White, non-Hispanic", "Another Race or Ethnicity"),
  Effect_Estimate = c(
    round(model_White$coefficients['PFDEA_cat0.2'], 1),
    round(model_Other$coefficients['PFDEA_cat0.2'], 1),
    round(model_White$coefficients['PFDEA_cat>0.2'], 1),
    round(model_Other$coefficients['PFDEA_cat>0.2'], 1)),
  CI_Lower = c(
    round(confint(model_White)["PFDEA_cat0.2", 1], 1),
    round(confint(model_Other)["PFDEA_cat0.2", 1], 1),
    round(confint(model_White)["PFDEA_cat>0.2", 1], 1),
    round(confint(model_Other)["PFDEA_cat>0.2", 1], 1)),
  CI_Upper = c(
    round(confint(model_White)["PFDEA_cat0.2", 2], 1),
    round(confint(model_Other)["PFDEA_cat0.2", 2], 1),
    round(confint(model_White)["PFDEA_cat>0.2", 2], 1),
    round(confint(model_Other)["PFDEA_cat>0.2", 2], 1)),
  P_Interaction = c(NA,round(summary(model_Other)$coefficients['PFDEA_cat0.2:momrace_relevOther', 'Pr(>|t|)'], 3),
    NA,round(summary(model_Other)$coefficients['PFDEA_cat>0.2:momrace_relevOther', 'Pr(>|t|)'], 3)))

# Expanding the dataset to have separate columns for each category of PFDEA
PFDEA_results2 <- PFDEA_results %>%
  pivot_wider(
    names_from = Group,
    values_from = c(Effect_Estimate, CI_Lower, CI_Upper, P_Interaction))

# Combining the effect estimates and CIs into a single string
PFDEA_results2 <- PFDEA_results2 %>%
  mutate(
    Estimate_CI_White = paste0(
      `Effect_Estimate_White, non-Hispanic`, 
      " (", `CI_Lower_White, non-Hispanic`, ", ", `CI_Upper_White, non-Hispanic`, ")"),
    Estimate_CI_Other = paste0(
      `Effect_Estimate_Another Race or Ethnicity`, 
      " (", `CI_Lower_Another Race or Ethnicity`, ", ", `CI_Upper_Another Race or Ethnicity`, ")"))

# Selecting and renaming the columns for the final data frame
Table_S3_PFDEA <- PFDEA_results2 %>%
  dplyr::select(
    PFDEA_Cat,
    Estimate_CI_White,
    Estimate_CI_Other,
    `P_Interaction_Another Race or Ethnicity`) %>%
  rename(
    "PFAS" = PFDEA_Cat,
    "P_Interaction" = `P_Interaction_Another Race or Ethnicity`)

# Stacking the output of these 2 tables
Table_S3 <- rbind(Table_S3_noPFDEA, Table_S3_PFDEA)

# Removing items that are unnecessary
rm(PFDEA_results, PFDEA_results2, model_Other, model_White, extract_results, process_pfas, Table_S3_noPFDEA, Table_S3_PFDEA)
```

This block of code 

  1. Evaluates effect measure modification by prenatal vitamin intake. 

Note. EMM for the 3 categories of the PFDEA was only evaluated in comparison to the ref (<0.2)
``` {r Table_S4}
# Adding a new prenatal_vitamin variable with reference level "Less than daily"
pfas_folate$prenatal_vitamin <- as.factor(pfas_folate$prenatal_vitamin)
pfas_folate$prenatal_vitamin_relev <- relevel(pfas_folate$prenatal_vitamin, ref = "Less than daily")

# Creating a helper function to extract and store results for both categories of prenatal vitamin intake
extract_results <- function(model, var_name) {
  coefs <- coef(summary(model))
  est <- round(coefs[var_name, "Estimate"], 1)
  ci <- round(confint(model, level = 0.95)[var_name, ], 1)
  combined <- paste0(est, " (", ci[1], ", ", ci[2], ")")
  p_val <- round(coefs[var_name, "Pr(>|t|)"], 3)
  return(data.frame(
    Estimate_CI = combined,
    P_Value = p_val,
    stringsAsFactors = FALSE))
}

# Creating a function to process multiple PFAS and extract results
process_pfas <- function(pfas_list, data) {
  combined_results <- data.frame(
    PFAS = character(),
    Estimate_CI_Less = character(),
    Estimate_CI_Every = character(),
    P_Value_Interact = numeric(),
    stringsAsFactors = FALSE)
  # Running it through the model
  for (pfas_var in names(pfas_list)) {
    model <- lm(as.formula(paste("WBF2 ~", pfas_var, "* prenatal_vitamin_relev +", pfas_var, "+ parity + prenatal_vitamin_relev + midincome + momagedeliv + cotinine_16w_log2")), data = data)
    # Extracting the results
    results_less <- extract_results(model, pfas_var)
    interaction_term <- paste0(pfas_var, ":prenatal_vitamin_relevEvery day")
    coefs <- coef(summary(model))
    if (interaction_term %in% rownames(coefs)) {
      interaction_p_val <- round(coefs[interaction_term, "Pr(>|t|)"], 3)
    } else {
      interaction_p_val <- NA
    }
    # Putting the results together in a data frame
    combined_results <- rbind(combined_results, data.frame(
      PFAS = pfas_list[[pfas_var]],
      Estimate_CI_Less = results_less$Estimate_CI,
      Estimate_CI_Every = results_less$Estimate_CI,
      P_Interaction = interaction_p_val,
      stringsAsFactors = FALSE))
  }
  return(combined_results)
}

# Running the results through each PFAS in the PFAS list
Interaction_vitamin <- process_pfas(pfas_list, pfas_folate)

# Evaluating the categorized PFDEA variable
model <- lm(WBF2 ~ PFDEA_cat * prenatal_vitamin_relev + PFDEA_cat + parity + prenatal_vitamin_relev + midincome + momagedeliv + cotinine_16w_log2, data = pfas_folate)

# Creating a data frame with the required values
PFDEA_results <- data.frame(
  PFDEA_Cat = c("=0.2", "=0.2", ">0.2", ">0.2"),
  Group = c("Less than daily", "Every day", "Less than daily", "Every day"),
  Effect_Estimate = c(
    round(model$coefficients['PFDEA_cat0.2'], 1),
    round(model$coefficients['PFDEA_cat0.2'], 1),
    round(model$coefficients['PFDEA_cat>0.2'], 1),
    round(model$coefficients['PFDEA_cat>0.2'], 1)),
  CI_Lower = c(
    round(confint(model)["PFDEA_cat0.2", 1], 1),
    round(confint(model)["PFDEA_cat0.2", 1], 1),
    round(confint(model)["PFDEA_cat>0.2", 1], 1),
    round(confint(model)["PFDEA_cat>0.2", 1], 1)),
  CI_Upper = c(
    round(confint(model)["PFDEA_cat0.2", 2], 1),
    round(confint(model)["PFDEA_cat0.2", 2], 1),
    round(confint(model)["PFDEA_cat>0.2", 2], 1),
    round(confint(model)["PFDEA_cat>0.2", 2], 1)),
  P_Interaction = c(NA,round(summary(model)$coefficients['PFDEA_cat0.2:prenatal_vitamin_relevEvery day', 'Pr(>|t|)'], 3),
                    NA,round(summary(model)$coefficients['PFDEA_cat>0.2:prenatal_vitamin_relevEvery day', 'Pr(>|t|)'], 3)))

# Reshaping the dataset to have separate columns for each category of PFDEA
PFDEA_results2 <- PFDEA_results %>%
  pivot_wider(names_from = Group, values_from = c(Effect_Estimate, CI_Lower, CI_Upper, P_Interaction))

# Combining the effect estimates and CIs into a single string
PFDEA_results2 <- PFDEA_results2 %>%
  mutate(Estimate_CI_Less = paste0(`Effect_Estimate_Less than daily`, " (", `CI_Lower_Less than daily`, ", ", 
                                    `CI_Upper_Less than daily`, ")"),
         Estimate_CI_Every = paste0(`Effect_Estimate_Every day`, " (", 
                                  `CI_Lower_Every day`, ", ", `CI_Upper_Every day`, ")"))

# Selecting and renaming the columns for the final data frame
PFDEA_results <- PFDEA_results2 %>%
  dplyr::select(PFDEA_Cat, Estimate_CI_Less, Estimate_CI_Every, `P_Interaction_Every day`) %>%
  rename("PFAS" = PFDEA_Cat, "P_Interaction" = `P_Interaction_Every day`)

# Stacking the output of these 2 tables
Table_S4 <- rbind(Interaction_vitamin, PFDEA_results)

# Printing the final results table
print(Table_S4)

# Removing items that are unnecessary
rm(Interaction_vitamin, PFDEA_results2, pfas_list, model, PFDEA_results, extract_results, process_pfas)
```
